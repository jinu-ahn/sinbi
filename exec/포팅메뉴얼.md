**JVM**<br/>
OpenJDK 17<br/>
JVM - Xmx4039m<br/>


**Frontend-WebServer**<br/>
Nginx 1.18.0<br/>

---
### IDE
WAS: Apache Tomcat, 3.3.2<br/>
Visual Studio Code, 1.91.0 

`InteliJ Dependency`

```gradle
plugins {
	id 'java'
	id 'org.springframework.boot' version '3.3.3'
	id 'io.spring.dependency-management' version '1.1.6'
	id 'org.asciidoctor.jvm.convert' version '3.3.2'
}
group = 'C104'
version = '0.0.1-SNAPSHOT'
java {
	toolchain {
		languageVersion = JavaLanguageVersion.of(17)
	}
}
configurations {
	compileOnly {
		extendsFrom annotationProcessor
	}
}
repositories {
	mavenCentral()
}
ext {
	set('snippetsDir', file("build/generated-snippets"))
}
dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	compileOnly 'org.projectlombok:lombok'
	developmentOnly 'org.springframework.boot:spring-boot-devtools'
	runtimeOnly 'com.mysql:mysql-connector-j'
	annotationProcessor 'org.projectlombok:lombok'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testImplementation 'org.springframework.restdocs:spring-restdocs-mockmvc'
	testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
	implementation 'org.springframework.boot:spring-boot-starter-validation'
	implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.0.2'
	//SMS
	implementation 'net.nurigo:sdk:4.3.0'
	//Kafka
	implementation 'org.springframework.kafka:spring-kafka'
	//redis
	implementation 'org.springframework.boot:spring-boot-starter-data-redis'
	// spring cloud config
	implementation 'org.springframework.boot:spring-boot-starter-actuator'
	implementation 'org.springframework.cloud:spring-cloud-config-client:4.1.3'
	// web client
	implementation 'org.springframework.boot:spring-boot-starter-webflux'
	//gson JSON 직렬화
	implementation 'com.google.code.gson:gson:2.8.8'
	//S3
	implementation 'org.springframework.cloud:spring-cloud-starter-aws:2.2.6.RELEASE'
	//Security
	implementation 'org.springframework.boot:spring-boot-starter-security'
	testImplementation 'org.springframework.security:spring-security-test'
	//JWT
	implementation 'io.jsonwebtoken:jjwt-api:0.11.5'
	implementation 'io.jsonwebtoken:jjwt-impl:0.11.5'
	implementation 'io.jsonwebtoken:jjwt-jackson:0.11.5'
}
tasks.named('test') {
	outputs.dir snippetsDir
	useJUnitPlatform()
}
tasks.named('asciidoctor') {
	inputs.dir snippetsDir
	dependsOn test
}
```
`React: Dependency`
```config
"dependencies": { "@emotion/react": "^11.13.0", "@emotion/styled": "^11.13.0", "@huggingface/inference": "^2.8.0", "@mui/icons-material": "^5.16.4", "@mui/joy": "^5.0.0-beta.48", "@mui/material": "^5.16.7", "@types/js-cookie": "^3.0.6", "@xyflow/react": "^12.0.4", "axios": "^1.3.1", "dayjs": "^1.11.12", "dotenv": "^16.4.5", "glob": "^11.0.0", "idb": "^8.0.0", "js-cookie": "^3.0.5", "jwt-decode": "^4.0.0", "moment": "^2.30.1", "quill": "^2.0.2", "quill-cursors": "^4.0.3", "react": "^18.3.1", "react-beautiful-dnd": "^13.1.1", "react-dom": "^18.3.1", "react-draggable": "^4.4.6", "react-hook-form": "^7.52.1", "react-router-dom": "^6.25.1", "react-speech-kit": "^3.0.1", "reactflow": "^11.11.4", "recoil": "^0.7.7", "recoil-nexus": "^0.5.1", "recoil-persist": "^5.1.0", "rimraf": "^6.0.1", "web-vitals": "^2.1.0", "y-indexeddb": "^9.0.12", "y-quill": "^1.0.0", "y-webrtc": "^10.3.0", "yjs": "^13.6.18" }
```
---
### Spring Cloud Config
```yml
server:
  servlet:
    context-path: /api
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://xx.164.159.xxx:3306/sinbi?useSSL=false&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
    username: root
    password: whaxxxxsqxxx
  kafka:
    bootstrap-servers: kafka.kafka.svc.cluster.local:9092  # 클러스터의 내부 Kafka 브로커 주소
    producer:
      auto-offset-reset: earliest
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      properties:
        security.protocol: PLAINTEXT
    consumer:
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      auto-offset-reset: earliest
      properties:
        security.protocol: PLAINTEXT
    listener:
      missing-topics-fatal: false  # KafkaListener에서 토픽이 없을 경우 에러 발생 방지
  jpa:
    open-in-view: true
    hibernate:
      ddl-auto: update
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
    # show-sql: true
    properties:
      hibernate.format_sql: true
      dialect: org.hibernate.dialect.MySQL8InnoDBDialect
# JWT
jwt:
  access_expiration_time: 3600000 # 1시간 액세스 토큰 만료 시간 설정
  refresh_expiration_time: 604800016 # 1주일 리프레시 토큰 만료 시간 설정
  secret: uw5YoYHImqxxxxpPrZ2pxxxxQkztIiJN/CMfhjnBwxxxxxxzeCvF4kQ2YUt5Ncpg== # JWT 시크릿 키 설정
```
--- 

### Configmap, Secrets

`secret.yaml`
```yaml
apiVersion: v1
data:
  OPENAI_API_KEY: c2stcxxxxxxxxx
kind: Secret
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
```

`mysql-secret.yaml`
```yaml
apiVersion: v1
data:
  admin-password: xxxxx
  password: xxxxx
kind: Secret
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"admin-password":"xxxxx","password":"xxxxx="},"kind":"Secret","metadata":{"annotations":{},"name":"mysql-secret","namespace":"mysql"},"type":"Opaque"}
  creationTimestamp: "2024-10-02T05:03:50Z"
  name: mysql-secret
  namespace: mysql
  resourceVersion: "11736219"
  uid: aa95314b-b863-4376-ba64-70fa5148cd36
type: Opaque
```

`redis-config.yaml`
```yaml
apiVersion: v1
data:
  REDIS_HOST: 34.47.86.148
  REDIS_PORT: "6379"
kind: ConfigMap
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"REDIS_HOST":"xx.xx.xx.xx","REDIS_PORT":"6379"},"kind":"ConfigMap","metadata":{"annotations":{},"name":"redis-config","namespace":"msa"}}
  creationTimestamp: "2024-10-06T09:46:43Z"
  managedFields:
  - apiVersion: v1
    fieldsType: FieldsV1
    fieldsV1:
      f:data:
        .: {}
        f:REDIS_HOST: {}
        f:REDIS_PORT: {}
      f:metadata:
        f:annotations:
          .: {}
          f:kubectl.kubernetes.io/last-applied-configuration: {}
    manager: kubectl-client-side-apply
    operation: Update
    time: "2024-10-06T09:46:43Z"
  name: redis-config
  namespace: msa
  resourceVersion: "15970119"
  uid: 82bc70f2-6f27-4f3e-b5e3-ef9d6d7a71f5
```

`redis-secret.yaml`
```yaml
apiVersion: v1
data:
  REDIS_PASSWORD: xxxx
kind: Secret
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"REDIS_PASSWORD":"xxxx"},"kind":"Secret","metadata":{"annotations":{},"name":"redis-secret","namespace":"msa"},"type":"Opaque"}
  creationTimestamp: "2024-10-06T09:45:53Z"
  name: redis-secret
  namespace: msa
  resourceVersion: "15969553"
  uid: 07baf620-bc3d-4f3f-b785-39a28355e831
type: Opaque
```

---

### Dockerfile

**Backend**
```Dockerfile
FROM openjdk:17
WORKDIR /app
Run ln -sf /usr/share/zoneinfo/Asia/Seoul /etc/localtime && \
    echo "Asia/Seoul" > /etc/timezone
ARG JAR_FILE=build/libs/*.jar
COPY ${JAR_FILE} app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

**Frontend**
```Dockerfile
FROM node:20 AS build
ENV NODE_OPTIONS=--max_old_space_size=1600
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 5173
CMD ["nginx", "-g", "daemon off;"]
```

`nginx.conf`
```conf
user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;
    sendfile        on;

    keepalive_timeout  65;

    include /etc/nginx/conf.d/*.conf;
    server {
        server_name sinbi.life;

        root /usr/share/nginx/html;
        index index.html;

        location / {
            try_files $uri /index.html;
        }

        location /sw.js {
            try_files $uri =404;
        }

        location /favicon.ico {
            try_files $uri =404;
        }
    }
}
```

### JenkinsFile
```Jenkinsfile
pipeline {
    agent any
    environment {
        DOCKERHUB_CREDENTIALS = credentials('docker-hub-credentials') // Docker Hub 자격 증명
        MATTERMOST_ENDPOINT = 'https://meeting.ssafy.com/hooks/bwr8icyss3dzprmdjy1eh8qs5c'
        MATTERMOST_CHANNEL = 'c104-jenkins'
        USER_IMAGE = 'siokim002/sinbi_user'
        FILTER_IMAGE = 'siokim002/sinbi_filter'
        ACCOUNT_IMAGE = 'siokim002/sinbi_account'
        VIRTUAL_ACCOUNT_IMAGE = 'siokim002/sinbi_virtual_account'
        FRONTEND_IMAGE = 'siokim002/sinbi_frontend'
        GITOPS_REPO = 'git@github.com:zion0425/sinbi_gitops.git' // GitOps 저장소 주소
        GITOPS_CREDENTIALS = 'gitops_pk' // Jenkins에 등록된 GitOps 배포 키의 Credential ID
        GITLAB_CREDENTIALS = 'gitlab' // GitLab 자격 증명 ID
    }
    options {
        buildDiscarder(logRotator(numToKeepStr: '3'))
    }
    stages {
        stage('Start Notification') {
            steps {
                script {
                    sendNotification('warning', '빌드 시작')
                }
            }
        }
        stage('Checkout') {
            steps {
                script {
                    // 소스 코드 체크아웃
                    git url: 'https://lab.ssafy.com/s11-ai-speech-sub1/S11P21C104.git', branch: 'release', credentialsId: GITLAB_CREDENTIALS
                    // 변경된 파일 목록 가져오기
                    def changes = sh(script: "git diff --name-only HEAD~1 HEAD", returnStdout: true).trim()
                    println "Changed files:\n${changes}"
                    // 변경된 서비스 확인
                    changedServices = []
                    if (changes.contains('frontend/')) {
                        changedServices.add('frontend')
                    }
                    if (changes.contains('filter/')) {
                        changedServices.add('filter')
                    }
                    if (changes.contains('user/')) {
                        changedServices.add('user')
                    }
                    if (changes.contains('account/')) {
                        changedServices.add('account')
                    }
                    if (changes.contains('virtualAccount/')) {
                        changedServices.add('virtualAccount')
                    }
                    println "Changed services: ${changedServices}"
                }
            }
        }
        stage('Build and Push Docker Images') {
            steps {
                script {
                    // Docker Hub 로그인
                    sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin'
                    for (service in changedServices) {
                        def imageName = ""
                        def dirPath = ""
                        if (service == 'frontend') {
                            imageName = FRONTEND_IMAGE
                            dirPath = 'frontend'
                        } else if (service == 'filter') {
                            imageName = FILTER_IMAGE
                            dirPath = 'filter'
                        } else if (service == 'user') {
                            imageName = USER_IMAGE
                            dirPath = 'user'
                        } else if (service == 'account') {
                            imageName = ACCOUNT_IMAGE
                            dirPath = 'account'
                        } else if (service == 'virtualAccount') {
                            imageName = VIRTUAL_ACCOUNT_IMAGE
                            dirPath = 'virtualAccount'
                        }
                        // Docker 이미지 빌드
                        dir(dirPath) {
                            if (service != 'frontend') {
                                sh 'chmod +x ./gradlew'
                                sh './gradlew clean build -x test'
                            }
                            sh "docker build --no-cache -t ${imageName}:${env.BUILD_NUMBER} ."
                        }
                        // Docker 이미지 푸시
                        sh "docker push ${imageName}:${env.BUILD_NUMBER}"
                    }
                }
            }
        }
        stage('Update GitOps Repo') {
            steps {
                script {
                    sshagent (credentials: [GITOPS_CREDENTIALS]) {
                        dir('gitops') {
                            // GitOps 저장소 클론
                            sh 'git clone -b main git@github.com:zion0425/sinbi_gitops.git .'
                            for (service in changedServices) {
                                def imageName = ""
                                def deploymentFile = ""
                                if (service == 'frontend') {
                                    imageName = FRONTEND_IMAGE
                                    deploymentFile = 'frontend-deployment.yaml'
                                } else if (service == 'filter') {
                                    imageName = FILTER_IMAGE
                                    deploymentFile = 'filter-deployment.yaml'
                                } else if (service == 'user') {
                                    imageName = USER_IMAGE
                                    deploymentFile = 'user-deployment.yaml'
                                } else if (service == 'account') {
                                    imageName = ACCOUNT_IMAGE
                                    deploymentFile = 'account-deployment.yaml'
                                } else if (service == 'virtualAccount') {
                                    imageName = VIRTUAL_ACCOUNT_IMAGE
                                    deploymentFile = 'virtual-account-deployment.yaml'
                                }
                                // deployment.yaml 파일의 이미지 태그 업데이트
                                sh """
                                sed -i 's#image: .*#image: ${imageName}:${env.BUILD_NUMBER}#' ${deploymentFile}
                                """
                            }
                            // 변경 사항 커밋 및 푸시
                            sh """
                            git config user.name "Jenkins"
                            git config user.email "jenkins@gitops.com"
                            git add .
                            git commit -m "Update images for services: ${changedServices.join(', ')}"
                            git push origin main
                            """
                        }
                    }
                }
            }
        }
    }
    post {
        success {
            script {
                sendNotification('good', '빌드 성공')
                cleanWs()
            }
        }
        failure {
            script {
                sendNotification('danger', '빌드 실패')
                cleanWs()
            }
        }
    }
}
def sendNotification(String color, String status) {
    def gitCommitterName = sh(script: "git log -1 --pretty=format:'%an'", returnStdout: true).trim()
    def gitCommitMessage = sh(script: "git log -1 --pretty=%B", returnStdout: true).trim()
    
    mattermostSend(
        color: color,
        message: """${status}: 빌드 번호 #${env.BUILD_NUMBER}
커밋 작성자: ${gitCommitterName}
커밋 메시지: ${gitCommitMessage}
(<${env.BUILD_URL}|빌드 상세 정보>)""",
        endpoint: MATTERMOST_ENDPOINT,
        channel: MATTERMOST_CHANNEL
    )
}
```
### Argo Application Detail
```
PROJECT- default
CLUSTER - in-cluster (https://kubernetes.default.svc)
NAMESPACE - msa   
REPO URL - https://github.com/zion0425/sinbi_gitops.git
TARGET REVISION - main
PATH - (root)
RETRY OPTIONS - Retry
IMAGES
 - siokim002/sinbi_account:78
 - siokim002/sinbi_filter:30
 - siokim002/sinbi_frontend:93
 - siokim002/sinbi_user:53
 - siokim002/sinbi_virtual_account:78
SYNC POLICY
 AUTOMATED - ENABLE AUTO-SYNC
 PRUNE RESOURCES - ENABLE
 SELF HEAL - ENABLE
````